<div class="project-wrapper">
  <div class="project-header" style="position: sticky; top: 0; z-index: 1000; background: #f1f5f9;">
    <div class="header-top-row">
      <input
      [(ngModel)]="projectTitle"
      (blur)="updateProjectTitle()"
      class="project-title-input"
      placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›"
      [disabled]="userRole === 'viewer'"
      />
  
      <div class="view-switch-group">
        <button class="view-button" [class.active]="currentView === 'list'" (click)="switchView('list')"><span class="material-icons">view_list</span>ä¸€è¦§è¡¨ç¤º</button>
        <button class="view-button" [class.active]="currentView === 'calendar'" (click)="switchView('calendar')"><span class="material-icons">calendar_today</span>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</button>
        <button class="member-button" (click)="openMemberDialog()" [disabled]="userRole === 'viewer'"><span class="material-icons">group</span>ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</button>
        <button class="complete-project-button" (click)="completeProject()" [disabled]="userRole === 'viewer'"><span class="material-icons">checklist_rtl</span>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†</button>
      </div>
    </div>
  </div> 
  

  <div *ngIf="currentView === 'list'" class="project-header" style="position: sticky; top: 0; z-index: 1000; background: #f1f5f9;">
    <div class="header-control-row">
      <input type="text" [(ngModel)]="searchKeyword" class="search-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æ‹…å½“è€…ã§æ¤œç´¢" />
      <button class="control-button" (click)="sortDialogOpen()"><span class="material-icons">swap_vert</span>ã‚½ãƒ¼ãƒˆ</button>
      <button class="control-button" (click)="filterDialogOpen()"><span class="material-icons">filter_alt</span>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</button>
      <button class="control-button" (click)="addSectionDialogOpen()" [disabled]="userRole === 'viewer'"><span class="material-icons">add</span>ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ </button>
      

      <div class="auto-move-wrapper">
        <label class="auto-move-toggle">
          <input type="checkbox" [(ngModel)]="autoMoveCompletedTasks" (change)="onToggleAutoMoveCompletedTasks()" [disabled]="userRole === 'viewer'" />
          <span class="toggle-switch"></span>
          <span class="toggle-label">å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•ã§å®Œäº†æ¸ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç§»å‹•</span>
        </label>
      </div>      
    </div>
  </div>

  <div *ngIf="currentView === 'list'" class="task-list-view2">
    <div class="section-drop-list-fixed2">
      <div class="task-section-fixed2">
        <div class="task-header-section-wrapper2">
          <div class="task-header static-header">
            <div class="task-content">
              <div class="task-title">ã‚¿ã‚¹ã‚¯å</div>
              <div class="task-meta-horizontal">
                <span class="meta-item assignee">æ‹…å½“è€…</span>
                <span class="meta-separator">ï½œ</span>
                <span class="meta-item dueDate">æœŸé™</span>
                <span class="meta-separator">ï½œ</span>
                <span class="meta-item status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
                <span class="meta-separator">ï½œ</span>
                <span class="meta-item priority">å„ªå…ˆåº¦</span>
                <span class="meta-separator">ï½œ</span>
                <span class="meta-item progress">é€²æ—ç‡</span>
                <span class="meta-separator">ï½œ</span>
                <span class="meta-item estimate">è¦‹ç©ã‚‚ã‚Š</span>
                <span class="meta-separator">ï½œ</span>
                <span class="meta-item actual">å®Ÿç¸¾</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="currentView === 'list'" class="task-list-view" #scrollContainer>
    <div
      cdkDropList
      class="section-drop-list"
      [cdkDropListData]="sectionsWithTasks"
      (cdkDropListDropped)="onSectionDrop($event)"
      [cdkDropListDisabled]="userRole === 'viewer'"
    >
      <div
        *ngFor="let entry of sectionsWithTasks"
        cdkDrag
        class="task-section-wrapper"
        [hidden]="selectedSections[0] !== 'ã™ã¹ã¦' && !selectedSections.includes(entry.section.title)"
      >

        <div class="task-section">
          <div class="section-header">
            <span class="arrow" (click)="toggleSection(entry.section.title)">
              {{ isSectionCollapsed(entry.section.title) ? 'â–¶' : 'â–¼' }}
            </span>

            <div class="section-title-wrapper">
              <ng-container *ngIf="editingSectionId !== entry.section.id">
                <h3
                  (click)="enableSectionEdit(entry.section)"
                  class="section-title"
                  title="ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†"
                >
                  {{ entry.section.title }}
                </h3>
                
              </ng-container>

              <ng-container *ngIf="editingSectionId === entry.section.id">
                <input [(ngModel)]="editingSectionTitle" class="section-edit-input" />
                <button class="save-section-button" (click)="saveEditedSectionTitle(entry.section, editingSectionTitle)" [disabled]="userRole === 'viewer'">ä¿å­˜</button>
                <button class="cancel-section-button" (click)="cancelEditSection()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              </ng-container>
            </div>

            <div class="add-task-button-wrapper">
              <button
                *ngIf="entry.section.title !== 'ç›®æ¨™ãƒ»ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³' && !entry.section.isFixed && userRole !== 'viewer'"
                (click)="startAddTask(entry.section.title)"
                class="section-action-button"
              >
                <span class="material-icons">add</span>æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ 
              </button>
            
              <!-- âœ… ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆåŒã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
              <button
                *ngIf="entry.section.title === 'ç›®æ¨™ãƒ»ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³' && userRole !== 'viewer'"
                (click)="createMilestone(entry.section.id)"
                class="section-action-button"
              >
                <span class="material-icons">add</span>ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¿½åŠ 
              </button>
            </div>
            
            <button (click)="copyTasksDialogOpen(entry.section)" class="section-action-button copy-task-button" *ngIf="entry.section.title !== 'ç›®æ¨™ãƒ»ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³' && !entry.section.isFixed && userRole !== 'viewer'"><span class="material-icons">content_copy</span>ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã‚¿ã‚¹ã‚¯ã‚’ä¸€æ‹¬è¤‡è£½</button>

            <button
            *ngIf="entry.section.title !== 'ç›®æ¨™ãƒ»ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³' && !entry.section.isFixed && userRole !== 'viewer'"
                  class="section-action-button delete-section-button"
                  (click)="deleteSectionDialogOpen(entry.section)"
                >
                <span class="material-icons">delete</span>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
              </button>

          </div>

          <div *ngIf="addingSection === entry.section.title" class="add-task-form">
            <input type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" [(ngModel)]="newTask.title" />
            <select [(ngModel)]="newTask.assignee">
              <option value="">-æ‹…å½“è€…æœªè¨­å®š-</option>
              <option *ngFor="let member of members" [value]="member.uid">
                {{ member.displayName }}
              </option>
            </select>
            <!-- <select [(ngModel)]="newTask.parentMilestoneId">
              <option value="">-ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³æœªè¨­å®š-</option>
              <option *ngFor="let ms of allMilestones" [value]="ms.id">
                {{ ms.title }}
              </option>
            </select> -->
            <input type="date" [(ngModel)]="newTask.dueDate" />
            <button (click)="saveTask()">ä¿å­˜</button>
            <button (click)="cancelAddTask()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>

          <ng-container *ngIf="!isSectionCollapsed(entry.section.title)">

            <div *ngIf="entry.section.title === 'ç›®æ¨™ãƒ»ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³'">
              <!-- ç›®æ¨™ã‚«ãƒ¼ãƒ‰ -->
<div class="goal-card">

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
  <div *ngIf="editingGoal; else goalStaticBlock" class="add-task-form">
    <input
      type="text"
      [(ngModel)]="newGoalTitle"
      placeholder="ã‚¿ã‚¤ãƒˆãƒ«"
    />
    <input
      type="date"
      [(ngModel)]="newGoalDueDate"
    />
    <button (click)="saveGoal()">ä¿å­˜</button>
    <button (click)="cancelEditGoal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <div class="goal-delete-placeholder"></div>
    
  </div>

  <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
  <ng-template #goalStaticBlock>
    <div class="task-title" (click)="editingGoal = true">
      ğŸ¯ {{ entry.goal?.title ?? 'ç›®æ¨™' }}
    </div>
    <span class="meta-item dueDate">æœŸæ—¥: {{ entry.goal?.dueDate }}</span>
    <div class="task-meta-horizontal">
      
      <!-- <span class="meta-separator">ï½œ</span>
      <span class="meta-item progress">é€²æ—ç‡: {{ entry.goal?.progress ?? 0 }}%</span> -->
    </div>
    <span class="meta-item progress">é€²æ—ç‡:</span>
    <div class="progress-bar-container">
      <div class="progress-bar-fill" [style.width.%]="entry.goal?.progress ?? 0"></div>
    </div>
  </ng-template>

</div>

              <!-- ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚«ãƒ¼ãƒ‰ -->
<div *ngFor="let ms of entry.milestones" class="milestone-card"  [class.completed]="ms.status === 'å®Œäº†'">
  <div *ngIf="editingMilestoneId === ms.id; else staticMilestone" class="add-task-form">
    <input
      type="text"
      [(ngModel)]="newMilestoneTitle"
      placeholder="ã‚¿ã‚¤ãƒˆãƒ«"
    />
    <input
      type="date"
      [(ngModel)]="newMilestoneDueDate"
    />
    <button (click)="saveMilestone(entry.section.id)">ä¿å­˜</button>
    <button (click)="cancelEditMilestone()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button (click)="deleteMilestone(entry.section.id, ms.id)" class="delete-milestone-button">
      <span class="material-icons">delete</span>å‰Šé™¤
    </button>
  </div>

  <ng-template #staticMilestone>
    <div class="task-title" (click)="startEditMilestone(ms)">
      ğŸ“Œ {{ ms.title ?? 'ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³' }}
    </div>
    <div class="task-meta-horizontal">
      <span class="meta-item dueDate">æœŸæ—¥: {{ ms.dueDate }}</span>
      <!-- <span class="meta-separator">ï½œ</span>
      <span class="meta-item progress">é€²æ—ç‡: {{ ms.progress }}%</span> -->
    </div>
<!-- 
    <span class="meta-item progress">é€²æ—ç‡:</span>
    <div class="progress-bar-container">
      <div class="progress-bar-fill" [style.width.%]="ms.progress"></div>
    </div> -->
  </ng-template>
</div>



            </div>


            <div
              [cdkDropListDisabled]="entry.section.isFixed === true || userRole === 'viewer'"
              cdkDropList
              [id]="'dropList-' + entry.section.id"
              [cdkDropListData]="entry.tasks"
              [cdkDropListConnectedTo]="connectedDropListIds"
              (cdkDropListDropped)="onTaskDrop($event, entry.section.title)"
              class="task-drop-zone"
            >
              <div
                *ngFor="let task of entry.tasks"
                cdkDrag
                class="task-card"
                [ngClass]="[
                  isOverdue(task) ? 'status-overdue' : '',
                  'status-' + task.status
                ]"
                (click)="openTaskPanel(task)"
              >
                <div class="task-content">
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-meta-horizontal">
                    <span class="meta-item assignee">{{ getAssigneeName(task.assignee) }}</span>
                    <span class="meta-separator">ï½œ</span>
                    <span class="meta-item dueDate">{{ formatDueDate(task.dueDate) }}</span>
                    <span class="meta-separator">ï½œ</span>
                    <span class="meta-item status">{{ task.status }}</span>
                    <span class="meta-separator">ï½œ</span>
                    <span class="meta-item priority">{{ task.priority }}</span>
                    <span class="meta-separator">ï½œ</span>
                    <span class="meta-item progress">{{ task.progress }}%</span>
                    <span class="meta-separator">ï½œ</span>
                    <span class="meta-item estimate">{{ task.estimate }}min</span>
                    <span class="meta-separator">ï½œ</span>
                    <span class="meta-item actual">{{ task.actual }}min</span>
                  </div>
                </div>
              </div>

              <div class="section-footer" *ngIf="entry.tasks.length > 0">
                <div class="task-meta-horizontal">
                  <div class="task-title">åˆè¨ˆ</div>
                  <div class="task-header-meta">
                    <span class="meta-item assignee"></span>
                    <span class="meta-separator"></span>
                    <span class="meta-item dueDate"></span>
                    <span class="meta-separator"></span>
                    <span class="meta-item status"></span>
                    <span class="meta-separator"></span>
                    <span class="meta-item priority"></span>
                    <span class="meta-separator"></span>
                    <span class="meta-item progress"></span>
                    <span class="meta-separator"></span>
                    <span class="meta-item">{{ calculateEstimateSum(entry.tasks) }}min</span>
                    <span class="meta-separator">ï½œ</span>
                    <span class="meta-item">{{ calculateActualSum(entry.tasks) }}min</span>
                  </div>
                </div>
              </div>

              <div class="empty-drop-zone" *ngIf="entry.tasks.length === 0 && entry.section.title !== 'ç›®æ¨™ãƒ»ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³'">
                ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ã‚¿ã‚¹ã‚¯ã‚’ç§»å‹•
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <div
  *ngIf="currentView === 'calendar'"
  class="calendar-header"
  style="position: sticky; top: 0; z-index: 1000; background: #f1f5f9;"
>

  <div class="calendar-control-row">

    <div class="calendar-month-row">
      <div class="current-month-label">{{ currentMonthLabel }}</div>
      
      <div class="month-switch-buttons">
        <button class="month-nav-button" (click)="goToPreviousMonth()">ï¼œå‰æœˆ</button>
        <button class="month-today-button" (click)="goToToday()">ä»Šæœˆ</button>
        <button class="month-nav-button" (click)="goToNextMonth()">æ¬¡æœˆï¼</button>
      </div>
    </div>

    

    <div class="calendar-summary-wrapper">
      <div class="summary-card">
        <div class="summary-title">{{ currentMonthLabel }}</div>
        <div class="summary-item">è¦‹ç©: {{ monthlyEstimateTotal }}min</div>
        <div class="summary-item">å®Ÿç¸¾: {{ monthlyActualTotal }}min</div>
        <div class="summary-item">ã‚¿ã‚¹ã‚¯å®Œäº†ç‡: {{ monthlyCompletionRate }}%</div>
      </div>
      
      <div class="summary-card">
        <div class="summary-title">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“</div>
        <div class="summary-item">è¦‹ç©: {{ estimateUntilNow }}min</div>
        <div class="summary-item">å®Ÿç¸¾: {{ actualUntilNow }}min</div>
        <div class="summary-item">ã‚¿ã‚¹ã‚¯å®Œäº†ç‡: {{ totalCompletionRate }}%</div>
      </div>
      
      <div class="summary-card highlight">
        <div class="summary-title">æœªå®Œäº†</div>
        <div class="summary-item">è¦‹ç©: {{ estimateIncompleteTotal }}min</div>
        <div class="summary-item">å®Ÿç¸¾: {{ actualIncompleteTotal }}min</div>
      </div>      
    </div>
  </div>
</div>

  <div *ngIf="currentView === 'calendar'">
    <app-calendar-view
    *ngIf="projectId"
    [projectId]="projectId"
    [currentDate]="currentDate"
    (monthlyEstimateTotalChange)="onMonthlyEstimateTotalChange($event)"
    (monthlyActualTotalChange)="onMonthlyActualTotalChange($event)"
    (estimateUntilNowChange)="onEstimateUntilNowChange($event)"
    (actualUntilNowChange)="onActualUntilNowChange($event)"
    (estimateIncompleteTotalChange)="onEstimateIncompleteTotalChange($event)"
    (monthlyCompletionRateChange)="onMonthlyCompletionRateChange($event)"
    (currentMonthLabelChange)="onCurrentMonthLabelChange($event)"></app-calendar-view>


  </div>

</div>