<div class="project-wrapper">
  <div class="project-header" style="position: sticky; top: 0; z-index: 1000; background: #f1f5f9;">
    <div class="header-top-row">
      <input
      [(ngModel)]="projectTitle"
      (blur)="updateProjectTitle()"
      class="project-title-input"
      placeholder="プロジェクト名を入力"
      [disabled]="userRole === 'viewer'"
      />
  
      <div class="view-switch-group">
        <button class="view-button" [class.active]="currentView === 'list'" (click)="switchView('list')"><span class="material-icons">view_list</span>一覧表示</button>
        <button class="view-button" [class.active]="currentView === 'calendar'" (click)="switchView('calendar')"><span class="material-icons">calendar_today</span>カレンダー表示</button>
        <button class="member-button" (click)="openMemberDialog()" [disabled]="userRole === 'viewer'"><span class="material-icons">group</span>メンバー管理</button>
        <button class="complete-project-button" (click)="completeProject()" [disabled]="userRole === 'viewer'"><span class="material-icons">checklist_rtl</span>プロジェクト完了</button>
      </div>
    </div>
  </div> 
  

  <div *ngIf="currentView === 'list'" class="project-header" style="position: sticky; top: 0; z-index: 1000; background: #f1f5f9;">
    <div class="header-control-row">
      <input type="text" [(ngModel)]="searchKeyword" class="search-input" placeholder="タイトル・担当者で検索" />
      <button class="control-button" (click)="sortDialogOpen()"><span class="material-icons">swap_vert</span>ソート</button>
      <button class="control-button" (click)="filterDialogOpen()"><span class="material-icons">filter_alt</span>フィルター</button>
      <button class="control-button" (click)="addSectionDialogOpen()" [disabled]="userRole === 'viewer'"><span class="material-icons">add</span>セクション追加</button>
      

      <div class="auto-move-wrapper">
        <label class="auto-move-toggle">
          <input type="checkbox" [(ngModel)]="autoMoveCompletedTasks" (change)="onToggleAutoMoveCompletedTasks()" [disabled]="userRole === 'viewer'" />
          <span class="toggle-switch"></span>
          <span class="toggle-label">完了タスクを自動で完了済セクションに移動</span>
        </label>
      </div>      
    </div>
  </div>

  <div *ngIf="currentView === 'list'" class="task-list-view2">
    <div class="section-drop-list-fixed2">
      <div class="task-section-fixed2">
        <div class="task-header-section-wrapper2">
          <div class="task-header static-header">
            <div class="task-content">
              <div class="task-title">タスク名</div>
              <div class="task-meta-horizontal">
                <span class="meta-item assignee">担当者</span>
                <span class="meta-separator">｜</span>
                <span class="meta-item dueDate">期限</span>
                <span class="meta-separator">｜</span>
                <span class="meta-item status">ステータス</span>
                <span class="meta-separator">｜</span>
                <span class="meta-item priority">優先度</span>
                <span class="meta-separator">｜</span>
                <span class="meta-item progress">進捗率</span>
                <span class="meta-separator">｜</span>
                <span class="meta-item estimate">見積もり</span>
                <span class="meta-separator">｜</span>
                <span class="meta-item actual">実績</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="currentView === 'list'" class="task-list-view" #scrollContainer>
    <div
      cdkDropList
      class="section-drop-list"
      [cdkDropListData]="sectionsWithTasks"
      (cdkDropListDropped)="onSectionDrop($event)"
      [cdkDropListDisabled]="userRole === 'viewer'"
    >
      <div
        *ngFor="let entry of sectionsWithTasks"
        cdkDrag
        class="task-section-wrapper"
        [hidden]="selectedSections[0] !== 'すべて' && !selectedSections.includes(entry.section.title)"
      >
        <div class="task-section">
          <div class="section-header">
            <span class="arrow" (click)="toggleSection(entry.section.title)">
              {{ isSectionCollapsed(entry.section.title) ? '▶' : '▼' }}
            </span>

            <div class="section-title-wrapper">
              <ng-container *ngIf="editingSectionId !== entry.section.id">
                <h3
                  (click)="enableSectionEdit(entry.section)"
                  class="section-title"
                  title="クリックで編集"
                >
                  {{ entry.section.title }}
                </h3>
                
              </ng-container>

              <ng-container *ngIf="editingSectionId === entry.section.id">
                <input [(ngModel)]="editingSectionTitle" class="section-edit-input" />
                <button class="save-section-button" (click)="saveEditedSectionTitle(entry.section, editingSectionTitle)" [disabled]="userRole === 'viewer'">保存</button>
                <button class="cancel-section-button" (click)="cancelEditSection()">キャンセル</button>
              </ng-container>
            </div>

            <div class="add-task-button-wrapper">
              <button (click)="startAddTask(entry.section.title)" class="section-action-button" *ngIf="!entry.section.isFixed && userRole !== 'viewer'"><span class="material-icons">add</span>新規タスク追加</button>
            </div>

            <button (click)="copyTasksDialogOpen(entry.section)" class="section-action-button copy-task-button" *ngIf="!entry.section.isFixed && userRole !== 'viewer'"><span class="material-icons">content_copy</span>セクション内タスクを一括複製</button>

            <button
                  *ngIf="!entry.section.isFixed && userRole !== 'viewer'"
                  class="section-action-button delete-section-button"
                  (click)="deleteSectionDialogOpen(entry.section)"
                >
                <span class="material-icons">delete</span>セクションを削除
              </button>

          </div>

          <div *ngIf="addingSection === entry.section.title" class="add-task-form">
            <input type="text" placeholder="タイトル" [(ngModel)]="newTask.title" />
            <select [(ngModel)]="newTask.assignee">
              <option value="">--担当者未設定--</option>
              <option *ngFor="let member of members" [value]="member.uid">
                {{ member.displayName }}
              </option>
            </select>
            <input type="date" [(ngModel)]="newTask.dueDate" />
            <button (click)="saveTask()">保存</button>
            <button (click)="cancelAddTask()">キャンセル</button>
          </div>

          <ng-container *ngIf="!isSectionCollapsed(entry.section.title)">
            <div
              [cdkDropListDisabled]="entry.section.isFixed === true || userRole === 'viewer'"
              cdkDropList
              [id]="'dropList-' + entry.section.id"
              [cdkDropListData]="entry.tasks"
              [cdkDropListConnectedTo]="connectedDropListIds"
              (cdkDropListDropped)="onTaskDrop($event, entry.section.title)"
              class="task-drop-zone"
            >
              <div
                *ngFor="let task of entry.tasks"
                cdkDrag
                class="task-card"
                [ngClass]="[
                  isOverdue(task) ? 'status-overdue' : '',
                  'status-' + task.status
                ]"
                (click)="openTaskPanel(task)"
              >
                <div class="task-content">
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-meta-horizontal">
                    <span class="meta-item assignee">{{ getAssigneeName(task.assignee) }}</span>
                    <span class="meta-separator">｜</span>
                    <span class="meta-item dueDate">{{ formatDueDate(task.dueDate) }}</span>
                    <span class="meta-separator">｜</span>
                    <span class="meta-item status">{{ task.status }}</span>
                    <span class="meta-separator">｜</span>
                    <span class="meta-item priority">{{ task.priority }}</span>
                    <span class="meta-separator">｜</span>
                    <span class="meta-item progress">{{ task.progress }}%</span>
                    <span class="meta-separator">｜</span>
                    <span class="meta-item estimate">{{ task.estimate }}min</span>
                    <span class="meta-separator">｜</span>
                    <span class="meta-item actual">{{ task.actual }}min</span>
                  </div>
                </div>
              </div>

              <div class="section-footer" *ngIf="entry.tasks.length > 0">
                <div class="task-meta-horizontal">
                  <div class="task-title">合計</div>
                  <div class="task-header-meta">
                    <span class="meta-item assignee"></span>
                    <span class="meta-separator"></span>
                    <span class="meta-item dueDate"></span>
                    <span class="meta-separator"></span>
                    <span class="meta-item status"></span>
                    <span class="meta-separator"></span>
                    <span class="meta-item priority"></span>
                    <span class="meta-separator"></span>
                    <span class="meta-item progress"></span>
                    <span class="meta-separator"></span>
                    <span class="meta-item">{{ calculateEstimateSum(entry.tasks) }}min</span>
                    <span class="meta-separator">｜</span>
                    <span class="meta-item">{{ calculateActualSum(entry.tasks) }}min</span>
                  </div>
                </div>
              </div>

              <div class="empty-drop-zone" *ngIf="entry.tasks.length === 0">
                ドラッグ＆ドロップでタスクを移動
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <div
  *ngIf="currentView === 'calendar'"
  class="calendar-header"
  style="position: sticky; top: 0; z-index: 1000; background: #f1f5f9;"
>

  <div class="calendar-control-row">

    <div class="calendar-month-row">
      <div class="current-month-label">{{ currentMonthLabel }}</div>
      
      <div class="month-switch-buttons">
        <button class="month-nav-button" (click)="goToPreviousMonth()">＜前月</button>
        <button class="month-today-button" (click)="goToToday()">今月</button>
        <button class="month-nav-button" (click)="goToNextMonth()">次月＞</button>
      </div>
    </div>

    

    <div class="calendar-summary-wrapper">
      <div class="summary-card">
        <div class="summary-title">{{ currentMonthLabel }}</div>
        <div class="summary-item">見積: {{ monthlyEstimateTotal }}min</div>
        <div class="summary-item">実績: {{ monthlyActualTotal }}min</div>
        <div class="summary-item">タスク消化率: {{ monthlyCompletionRate }}%</div>
      </div>
      
      <div class="summary-card">
        <div class="summary-title">プロジェクト全体</div>
        <div class="summary-item">見積: {{ estimateUntilNow }}min</div>
        <div class="summary-item">実績: {{ actualUntilNow }}min</div>
        <div class="summary-item">タスク消化率: {{ totalCompletionRate }}%</div>
      </div>
      
      <div class="summary-card highlight">
        <div class="summary-title">未完了</div>
        <div class="summary-item">見積: {{ estimateIncompleteTotal }}min</div>
        <div class="summary-item">実績: {{ actualIncompleteTotal }}min</div>
      </div>      
    </div>
  </div>
</div>

  <div *ngIf="currentView === 'calendar'">
    <app-calendar-view
    *ngIf="projectId"
    [projectId]="projectId"
    [currentDate]="currentDate"
    (monthlyEstimateTotalChange)="onMonthlyEstimateTotalChange($event)"
    (monthlyActualTotalChange)="onMonthlyActualTotalChange($event)"
    (estimateUntilNowChange)="onEstimateUntilNowChange($event)"
    (actualUntilNowChange)="onActualUntilNowChange($event)"
    (estimateIncompleteTotalChange)="onEstimateIncompleteTotalChange($event)"
    (monthlyCompletionRateChange)="onMonthlyCompletionRateChange($event)"
    (currentMonthLabelChange)="onCurrentMonthLabelChange($event)"></app-calendar-view>


  </div>

</div>