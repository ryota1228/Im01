<div class="project-wrapper">
  <div class="project-header">
    <input
      [(ngModel)]="projectTitle"
      (blur)="updateProjectTitle()"
      class="project-title-input"
      placeholder="プロジェクト名を入力"
    />
    <div class="project-controls">
      <button (click)="currentView = 'list'" [class.active]="currentView === 'list'">一覧表示</button>
      <button (click)="currentView = 'calendar'" [class.active]="currentView === 'calendar'">カレンダー表示</button>
      <button class="members-button">参加者</button>
    </div>
  </div>

  <div *ngIf="currentView === 'list'" class="task-list-view" #scrollContainer>
    <div class="filter-controls">
      <label>
        <input type="text" [(ngModel)]="searchKeyword" placeholder="タイトル・担当者で検索" />
      </label>

      <button (click)="sortDialogOpen()">ソート</button>

      <button (click)="filterDialogOpen()">フィルター</button>

      <button (click)="addSectionDialogOpen()">セクション追加</button>

    </div>

    <div
      cdkDropList
      class="section-drop-list"
      [cdkDropListData]="sectionsWithTasks"
      (cdkDropListDropped)="onSectionDrop($event)"
    >
      <div
        *ngFor="let entry of sectionsWithTasks"
        cdkDrag
        class="task-section-wrapper"
        [hidden]="selectedSections[0] !== 'すべて' && !selectedSections.includes(entry.section.title)"
      >
        <div class="task-section">
          <div class="section-header">
            <span class="arrow" (click)="toggleSection(entry.section.title)">
              {{ isSectionCollapsed(entry.section.title) ? '▶' : '▼' }}
            </span>

            <ng-container *ngIf="editingSectionId !== entry.section.id">
              <h3 (dblclick)="enableSectionEdit(entry.section)" class="section-title">
                {{ entry.section.title }}
              </h3>
              <ng-container *ngIf="entry.section.title !== '完了済' && entry.section.isFixed !== true">
                <button (click)="enableSectionEdit(entry.section)">編集</button>
                <button (click)="deleteSectionDialogOpen(entry.section)">削除</button>
              </ng-container>
            </ng-container>

            <ng-container *ngIf="editingSectionId === entry.section.id">
              <input [(ngModel)]="editingSectionTitle" />
              <button (click)="saveEditedSectionTitle(entry.section, editingSectionTitle)">保存</button>
              <button (click)="cancelEditSection()">キャンセル</button>
            </ng-container>

            <ng-container *ngIf="entry.section.isFixed !== true">
              <button (click)="startAddTask(entry.section.title)">＋タスク追加</button>
            </ng-container>
          </div>

          <div *ngIf="addingSection === entry.section.title" class="add-task-form">
            <input type="text" placeholder="タイトル" [(ngModel)]="newTask.title" />

            <select [(ngModel)]="newTask.assignee">
              <option value="">--未設定--</option>
              <option *ngFor="let member of members" [value]="member.uid">
                {{ member.displayName }}
              </option>
            </select>

            <input type="date" [(ngModel)]="newTask.dueDate" />
            <button (click)="saveTask()">保存</button>
            <button (click)="cancelAddTask()">キャンセル</button>
          </div>

          <ng-container *ngIf="!isSectionCollapsed(entry.section.title)">
            <div
              [cdkDropListDisabled]="entry.section.isFixed === true"
              cdkDropList
              [id]="'dropList-' + entry.section.id"
              [cdkDropListData]="entry.tasks"
              [cdkDropListConnectedTo]="connectedDropListIds"
              (cdkDropListDropped)="onTaskDrop($event, entry.section.title)"
              class="task-drop-zone"
            >
              <div
                *ngFor="let task of entry.tasks"
                cdkDrag
                [hidden]="
                  (selectedStatuses[0] !== 'すべて' && !selectedStatuses.includes(task.status)) ||
                  (hideCompleted && task.status === '完了') ||
                  (searchKeyword && !(task.title.toLowerCase().includes(searchKeyword.toLowerCase())||
                  task.assignee.toLowerCase().includes(searchKeyword.toLowerCase())))
                "
                class="task-card"
                [ngClass]="'status-' + task.status"
                (click)="openTaskPanel(task)">

                <div class="task-title">{{ task.title }}</div>
                
                <div class="task-meta">
                  <span>担当: {{ getAssigneeName(task.assignee) }}</span>
                  <span>期限: {{ task.dueDate?.toDate ? (task.dueDate.toDate() | date: 'yyyy-MM-dd') : (task.dueDate | date: 'yyyy-MM-dd') }}</span>
                  <span>状態: {{ task.status }}</span>
                  <span>優先度: {{ task.priority }}</span>
                  <span>進捗率: {{ task.progress }}%</span>
                </div>
              </div>
              <div class="empty-drop-zone" *ngIf="entry.tasks.length === 0">ドラッグ＆ドロップでタスクを移動</div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="currentView === 'calendar'">
    <p>未実装です、、、
    </p>
  </div>
</div>
