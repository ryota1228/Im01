<div class="project-wrapper">
  <div class="project-header">
    <input
      [(ngModel)]="projectTitle"
      (blur)="updateProjectTitle()"
      class="project-title-input"
      placeholder="プロジェクト名を入力"/>

    <div class="project-controls">
      <button (click)="currentView = 'list'" [class.active]="currentView === 'list'">一覧表示</button>
      <button (click)="currentView = 'calendar'" [class.active]="currentView === 'calendar'">カレンダー表示</button>
      <button class="members-button">参加者</button>
    </div>
  </div>

  <div *ngIf="currentView === 'list'" class="task-list-view" #scrollContainer>
    <div class="filter-controls">
      <label>検索:
        <input type="text" [(ngModel)]="searchKeyword" placeholder="タイトル・担当者を検索" />
      </label>

      <label>並び順:
        <select [(ngModel)]="selectedSort">
          <option value="期限昇順">期限昇順</option>
          <option value="期限降順">期限降順</option>
        </select>
      </label>

      <button (click)="filterDialogOpen()">フィルター</button>

      <label>
        <input type="checkbox" [(ngModel)]="hideCompleted" />
        完了タスクを隠す
      </label>
    </div>

    <div
      cdkDropList
      class="section-drop-list"
      [cdkDropListData]="sectionsWithTasks"
      (cdkDropListDropped)="onSectionDrop($event)">
      <div
        *ngFor="let entry of sectionsWithTasks"
        cdkDrag
        class="task-section-wrapper"
        [hidden]="selectedSections[0] !== 'すべて' && !selectedSections.includes(entry.section.title)">
        <div class="task-section">
          <div class="section-header">
            <span class="arrow" (click)="toggleSection(entry.section.title)">
              {{ isSectionCollapsed(entry.section.title) ? '▶' : '▼' }}
            </span>
          
            <!-- 編集モードでないとき（タイトル表示） -->
            <ng-container *ngIf="editingSectionId !== entry.section.id">
              <h3 (dblclick)="enableSectionEdit(entry.section)">
                {{ entry.section.title }}
              </h3>
              <button (click)="enableSectionEdit(entry.section)">編集</button>
            </ng-container>
          
            <!-- 編集モードのとき（inputで編集） -->
            <ng-container *ngIf="editingSectionId === entry.section.id">
              <input [(ngModel)]="editingSectionTitle" />
              <button (click)="saveEditedSectionTitle(entry.section, editingSectionTitle)">保存</button>
              <button (click)="cancelEditSection()">キャンセル</button>
            </ng-container>
          
            <button (click)="startAddTask(entry.section.title)">＋タスク追加</button>
          </div>          
          
          <div *ngIf="!isSectionCollapsed(entry.section.title)">
            <div
            class="task-list"
            cdkDropList
            [id]="'dropList-' + entry.section.title"
            [cdkDropListData]="entry.tasks"
            [cdkDropListConnectedTo]="connectedDropListIds"
            (cdkDropListDropped)="onTaskDrop($event, entry.section.title)">

            <div *ngIf="entry.tasks.length === 0" class="empty-drop-zone">
              このセクションにはまだタスクがありません（ここにドロップ可能）</div>
      
            <div
              *ngFor="let task of entry.tasks"
              class="task-card"
              cdkDrag
              [ngClass]="'status-' + task.status"
              (click)="openTaskPanel(task)">
              <div class="task-title">{{ task.title }}</div>
              <div class="task-meta">
                <span>担当: {{ task.assignee }}</span>
                <span>期限: {{ task.dueDate?.toDate() | date: 'yyyy-MM-dd' }}</span>
                <span>状態: {{ task.status }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>      
    </div>
  </div>
</div>

  <div *ngIf="currentView === 'calendar'">
    <p>未実装なう</p>
  </div>
</div>
