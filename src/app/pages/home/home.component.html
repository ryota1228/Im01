<div class="dashboard-wrapper">
  <h1>ダッシュボード</h1>

  <div class="home-grid">
    <!-- 左カラム -->
    <div class="home-main">
      <div class="section">
        <h2>今日が期限のタスク</h2><div>現在日時：{{ currentTime | date: 'MM/dd HH:mm:ss' }}</div>
        <div class="section-scrollable">
        <div *ngIf="isLoading">読み込み中...</div>
        <ul *ngIf="!isLoading && todaysTasks.length > 0">
          <li *ngFor="let task of todaysTasks" (click)="openTask(task)">
            {{ task.title }}（進捗率：{{ task.progress }}%）
          </li>
        </ul>
        <p *ngIf="!isLoading && todaysTasks.length === 0">今日期限のタスクはありません</p>
        </div>
      </div>

      <div class="section">
        <h2>期限超過タスク</h2>
        <div class="section-scrollable">
        <ul *ngIf="delayedTasks.length > 0">
          <li *ngFor="let task of delayedTasks" (click)="openTask(task)">
            {{ task.title }}（期限: {{ task.dueDate | date: 'MM/dd' }}）
          </li>
        </ul>
        <p *ngIf="delayedTasks.length === 0">期限超過中のタスクはありません</p>
        </div>
      </div>

      <div class="section">
        <h2>参加中のプロジェクト</h2>
        <div class="section-scrollable">
        <ul>
          <li *ngFor="let project of sortedProjects" (click)="goToProject(project.id)">
            <strong>{{ project.title }}</strong>
            （期限: {{ project.dueDate | date: 'MM/dd' }} / 遅延: {{ project.delayedCount }}件）
            <button
              class="pin-button"
              [class.pinned]="project.pinned"
              (click)="togglePin(project.id); $event.stopPropagation();"
            >
              <mat-icon>push_pin</mat-icon>{{ project.pinned ? '解除' : '上部に固定' }}
            </button>
          </li>
        </ul>
        
        </div>
      </div>

      <div class="section">
        <h2>今週のタスク</h2>
        <div class="section-scrollable">
        <app-calendar-view
          [mode]="'week'"
          [embedded]="true"
          [currentDate]="currentTime"
          [userId]="uid">
        </app-calendar-view>
        </div>
      </div>
    </div>

    <!-- 右カラム -->
    <div class="home-side">
      <div class="notification-preview">
        <h2>通知</h2>
        <div class="notification-filters">
          <label>
            <input type="checkbox" [checked]="showUnreadOnly" (change)="toggleUnreadOnly($event)"> 未読のみ
          </label>
        
          <div class="filter-group">
            <div class="filter-group-title">通知の種別</div>
            <label><input type="checkbox" (change)="toggleType('new')" [checked]="selectedTypes.includes('new')"> 新規</label>
            <label><input type="checkbox" (change)="toggleType('update')" [checked]="selectedTypes.includes('update')"> 更新</label>
            <label><input type="checkbox" (change)="toggleType('deadline')" [checked]="selectedTypes.includes('deadline')"> 期日</label>
          </div>
        </div>

        
        <div class="section-scrollable">
        <div *ngIf="notifications.length === 0">通知はまだありません</div>

        <ul>
          <li *ngFor="let n of filteredNotifications" (click)="onClickNotification(n)">            
            <span *ngIf="!n.isRead">🟠</span><strong>{{ getTypeLabel(n.type) }}</strong>{{ n.taskName }}<span class="timestamp">（{{ n.timestamp.toDate() | date: 'yyyy/MM/dd HH:mm' }}）</span>
          </li>
        </ul>
        




        </div>
      </div>

      <div class="section">
        <h2>チャット通知</h2>
        <div class="section-scrollable">
          <ul>
              <li
              *ngFor="let notif of chatNotifications"
              [class.unread]="!notif.isRead"
              (click)="onClickChatNotification(notif)"
            >
              <span *ngIf="!notif.isRead">🟠</span>
              <strong>{{ notif.message }}</strong>（{{ notif.fromName }}/{{ notif.createdAt | date:'shortTime' }}）
            </li>
          </ul>
        </div>
      </div>
      
      


    </div>
  </div>
</div>
