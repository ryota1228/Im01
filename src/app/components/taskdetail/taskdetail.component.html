<div class="task-detail-panel" *ngIf="task">

  <div class="validation-error" *ngIf="validationError">
    {{ validationError }}
  </div>

  <div class="form-scroll-area">
    <div class="form-group">
      <label>タイトル</label>
      <input [(ngModel)]="task.title" type="text" [disabled]="isViewerUser" [ngClass]="{ 'input-error': !task.title }" />
    </div>

    <div class="form-group">
      <label>担当者</label>
      <select [(ngModel)]="task.assignee" [disabled]="isViewerUser">
        <option value="">--未設定--</option>
        <option *ngFor="let member of members" [value]="member.uid">
          {{ member.displayName }}
        </option>
      </select>
    </div>

    <div class="form-group">
      <label>期限</label>
      <input type="date" [(ngModel)]="dueDateString" (ngModelChange)="onDueDateChange($event)" [disabled]="isViewerUser" [ngClass]="{ 'input-error': !task.dueDate }" />
    </div>

    <div class="form-group">
      <label>優先度</label>
      <select [(ngModel)]="task.priority" [disabled]="isViewerUser">
        <option value="">未設定</option>
        <option value="低">低</option>
        <option value="中">中</option>
        <option value="高">高</option>
        <option value="最優先">最優先</option>
      </select>
    </div>

    <div class="form-group">
      <label>状態</label>
      <select [(ngModel)]="task.status" [disabled]="isViewerUser">
        <option value="未着手">未着手</option>
        <option value="進行中">進行中</option>
        <option value="完了">完了</option>
        <option value="確認待ち">確認待ち</option>
        <option value="確認中">確認中</option>
        <option value="差し戻し">差し戻し</option>
      </select>
    </div>

    <div class="form-group">
      <label>セクション</label>
      <select [(ngModel)]="task.section" [disabled]="isViewerUser" [ngClass]="{ 'input-error': !task.section || task.section === '' }">
        <ng-container *ngFor="let section of sections">
          <option *ngIf="section.title !== '目標・マイルストーン'" [value]="section.title">
            {{ section.title }}
          </option>
        </ng-container>
      </select>
    </div>

    <div class="form-group">
      <label>プロジェクト</label>
      <input type="text" [value]="projectTitle" disabled />
    </div>

    <div class="form-group">
      <label>進捗率 (%)</label>
      <select [(ngModel)]="task.progress" [disabled]="isViewerUser">
        <option *ngFor="let p of [0,10,20,30,40,50,60,70,80,90,100]" [value]="p">{{ p }}</option>
      </select>
    </div>

    <div class="form-group">
      <label>見積（min）</label>
      <input type="number" min="0" [(ngModel)]="task.estimate" [disabled]="isViewerUser" />
    </div>

    <div class="form-group">
      <label>実績（min）</label>
      <input type="number" min="0" [(ngModel)]="task.actual" [disabled]="isViewerUser" />
    </div>

    <div class="form-group rich-description" [class.focused]="isDescriptionFocused"
     (focusin)="onDescriptionFocus()" (focusout)="onDescriptionBlur()">

  <label class="form-label description-label">タスク詳細</label>

  <div class="description-wrapper">
    <div id="task-toolbar" class="quill-toolbar">
      <span class="ql-formats">
        <button class="ql-bold" aria-label="太字"></button>
        <button class="ql-italic" aria-label="斜体"></button>
        <button class="ql-underline" aria-label="下線"></button>

        <button class="ql-list" value="ordered" aria-label="番号付きリスト"></button>
        <button class="ql-list" value="bullet" aria-label="箇条書きリスト"></button>

        <select class="ql-header" aria-label="見出し">
          <option selected></option>
          <option value="1"></option>
          <option value="2"></option>
        </select>
      </span>
    </div>

    <quill-editor
    class="description-editor"
    #quillEditor
    [formControl]="descriptionControl"
    [modules]="{ toolbar: '#task-toolbar' }"
    placeholder="タスクの詳細を入力してください..."></quill-editor>
  </div>
</div>


    <div class="form-group">
      <label>チャット</label>
      <textarea
  [(ngModel)]="chatInput"
  (input)="onChatInput()"
  placeholder="@(半角)+ユーザー名"
></textarea>

<ul *ngIf="mentionCandidates.length > 0" class="mention-suggestions">
  <li *ngFor="let candidate of mentionCandidates" (click)="selectMention(candidate)">{{ '@' + candidate.displayName }}</li>
</ul>

<button (click)="sendChatMessage()" class="custom-button apply-button">送信</button>


      

    </div>

<div class="chat-log-toggle" (click)="showChatLog = !showChatLog">
  {{ showChatLog ? '▼' : '▶' }}ログ
</div>

<div class="form-group" *ngIf="showChatLog">
  <label></label>
  <div class="chat-log-box">
    <div *ngFor="let log of chatLogs" class="chat-log-entry">
      <strong>{{ getChatUserName(log.from) }} → {{ getChatUserName(log.to) }}:</strong>
      <div class="chat-message-content">{{ log.message }}</div>
    </div>
  </div>
</div>



    <div class="form-group file-list-wrapper">
      <label>添付ファイル</label>
    

      <div class="upload-controls">
        <label class="upload-button">
          ファイル選択
          <input type="file" (change)="onFileSelected($event)" hidden  [disabled]="isViewerUser"/>
        </label>
      </div>
    

      <ul class="uploaded-file-list">
        <li *ngFor="let file of uploadedFiles" class="uploaded-file-item">
          <a [href]="file.data" [download]="file.name" title="{{ file.name }}">{{ file.name }}</a>
          <button class="delete-file-button" (click)="deleteFile(file.id)" [disabled]="isViewerUser">✕</button>
        </li>
      </ul>
    </div>    



    <div class="form-group history-toggle">
      <div class="toggle-row">
        <button class="toggle-button" (click)="toggleHistory()">
          {{ isHistoryOpen ? '▲ 更新履歴（クリックで非表示）' : '▼ 更新履歴（クリックで表示）' }}
        </button>
      </div>

      <div *ngIf="isHistoryOpen" class="history-content-scrollable">
        <ng-container *ngFor="let entry of reversedHistory">
          <div *ngIf="entry.field && (entry.before !== undefined || entry.after !== undefined)" class="history-entry" [hidden]="!entry.before && !entry.after && !entry.changedBy && !entry.timestamp">
            <strong>{{getFieldLabel(entry.field)}}：</strong>
            <ng-container *ngIf="entry.field === 'assignee'; else normalChange">
              {{historyUserMap.get(entry.before + '') || entry.before}} →
              {{historyUserMap.get(entry.after + '') || entry.after}}
            </ng-container>
            <ng-template #normalChange>
              {{entry.before}} → {{entry.after}}
            </ng-template>
            <div class="history-meta" *ngIf="entry.changedBy || entry.timestamp">
              <span *ngIf="entry.changedBy">
                {{historyUserMap.get(entry.changedBy + '') || entry.changedBy}} が
              </span>
              <span *ngIf="entry.timestamp | safeDate as ts">
                {{ts | date:'yyyy/MM/dd HH:mm'}}に更新
              </span>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <div class="form-actions" *ngIf="!isViewerUser">
      <button mat-stroked-button color="warn" (click)="confirmDeleteDialog()">
        <span class="material-icons">delete</span> 削除
      </button>

      <button mat-stroked-button color="basic" (click)="isBlockingDialogOpen ? null : cancelEdit()">
        <span class="material-icons">undo</span>  戻る
      </button>

      <button mat-flat-button color="accent" (click)="openDuplicateDialog()">
        <span class="material-icons">content_copy</span> 複製
      </button>

      <button mat-flat-button color="primary" (click)="saveTask()">
        <span class="material-icons">save</span> 保存
      </button>
    </div>

  </div>
</div>
