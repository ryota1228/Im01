<div class="task-detail-panel" *ngIf="task">
  <button class="back-button" (click)="onClosePanel()">â† ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã‚‹</button>

  <div class="validation-error" *ngIf="validationError">
    {{ validationError }}
  </div>

  <div class="form-scroll-area">
    <div class="form-group">
      <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input [(ngModel)]="task.title" type="text" [disabled]="userRole === 'viewer'" [ngClass]="{ 'input-error': !task.title }" />
    </div>

    <div class="form-group">
      <label>æ‹…å½“</label>
      <select [(ngModel)]="task.assignee" [disabled]="userRole === 'viewer'">
        <option value="">--æœªè¨­å®š--</option>
        <option *ngFor="let member of members" [value]="member.uid">
          {{ member.displayName }}
        </option>
      </select>
    </div>

    <div class="form-group">
      <label>æœŸé™</label>
      <input type="date" [(ngModel)]="dueDateString" (ngModelChange)="onDueDateChange($event)" [disabled]="userRole === 'viewer'" [ngClass]="{ 'input-error': !task.dueDate }" />
    </div>

    <div class="form-group">
      <label>å„ªå…ˆåº¦</label>
      <select [(ngModel)]="task.priority" [disabled]="userRole === 'viewer'">
        <option value="">æœªè¨­å®š</option>
        <option value="ä½">ä½</option>
        <option value="ä¸­">ä¸­</option>
        <option value="é«˜">é«˜</option>
        <option value="æœ€å„ªå…ˆ">æœ€å„ªå…ˆ</option>
      </select>
    </div>

    <div class="form-group">
      <label>çŠ¶æ…‹</label>
      <select [(ngModel)]="task.status" [disabled]="userRole === 'viewer'">
        <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
        <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
        <option value="å®Œäº†">å®Œäº†</option>
        <option value="ç¢ºèªå¾…ã¡">ç¢ºèªå¾…ã¡</option>
        <option value="ç¢ºèªä¸­">ç¢ºèªä¸­</option>
        <option value="å·®ã—æˆ»ã—">å·®ã—æˆ»ã—</option>
      </select>
    </div>

    <div class="form-group">
      <label>ã‚»ã‚¯ã‚·ãƒ§ãƒ³</label>
      <select [(ngModel)]="task.section" [disabled]="userRole === 'viewer'" [ngClass]="{ 'input-error': !task.section || task.section === '' }">
        <option *ngFor="let section of sections" [value]="section.title">{{ section.title }}</option>
      </select>
    </div>

    <div class="form-group">
      <label>é€²æ—ç‡ (%)</label>
      <select [(ngModel)]="task.progress" [disabled]="userRole === 'viewer'">
        <option *ngFor="let p of [0,10,20,30,40,50,60,70,80,90,100]" [value]="p">{{ p }}</option>
      </select>
    </div>

    <div class="form-group">
      <label>è¦‹ç©ï¼ˆminï¼‰</label>
      <input type="number" min="0" [(ngModel)]="task.estimate" [disabled]="userRole === 'viewer'" />
    </div>

    <div class="form-group">
      <label>å®Ÿç¸¾ï¼ˆminï¼‰</label>
      <input type="number" min="0" [(ngModel)]="task.actual" [disabled]="userRole === 'viewer'" />
    </div>

    <div class="form-group rich-description" [class.focused]="isDescriptionFocused"
     (focusin)="onDescriptionFocus()" (focusout)="onDescriptionBlur()">

  <label class="form-label description-label">ã‚¿ã‚¹ã‚¯è©³ç´°</label>

  <div class="description-wrapper">
    <div id="task-toolbar" class="quill-toolbar">
      <span class="ql-formats">
        <button class="ql-bold" aria-label="å¤ªå­—"></button>
        <button class="ql-italic" aria-label="æ–œä½“"></button>
        <button class="ql-underline" aria-label="ä¸‹ç·š"></button>

        <button class="ql-list" value="ordered" aria-label="ç•ªå·ä»˜ããƒªã‚¹ãƒˆ"></button>
        <button class="ql-list" value="bullet" aria-label="ç®‡æ¡æ›¸ããƒªã‚¹ãƒˆ"></button>

        <select class="ql-header" aria-label="è¦‹å‡ºã—">
          <option selected></option>
          <option value="1"></option>
          <option value="2"></option>
        </select>
      </span>
    </div>

    <quill-editor
    class="description-editor"
    #quillEditor
    [formControl]="descriptionControl"
    [modules]="{ toolbar: '#task-toolbar' }"
    placeholder="ã‚¿ã‚¹ã‚¯ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></quill-editor>
  </div>
</div>

    <div class="form-group">
      <label>ãƒãƒ£ãƒƒãƒˆ</label>
      <textarea [(ngModel)]="task.chat" placeholder="ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°" [disabled]="userRole === 'viewer'"></textarea>
    </div>

    <div class="form-group file-list-wrapper">
      <label>ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜</label>
      <div class="file-upload-group">
        <label class="upload-button">
          ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
          <input type="file" multiple (change)="onFileSelected($event)" hidden />
        </label>
        <ul class="attached-file-list">
          <li class="file-item" *ngFor="let file of attachedFiles">
            <span class="file-icon">ğŸ“„</span>
            <span class="file-name" title="{{ file.name }}">{{ file.name }}</span>
            <button (click)="removeFile(file)" class="delete-btn">å‰Šé™¤</button>
            <button class="file-remove-button" (click)="removeFile(file)">âœ•</button>
          </li>
        </ul>
      </div>
    </div>

    <!-- æ›´æ–°å±¥æ­´ -->
    <div class="form-group history-toggle">
      <div class="toggle-row">
        <button class="toggle-button" (click)="toggleHistory()">
          {{ isHistoryOpen ? 'â–² æ›´æ–°å±¥æ­´ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§éè¡¨ç¤ºï¼‰' : 'â–¼ æ›´æ–°å±¥æ­´ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤ºï¼‰' }}
        </button>
      </div>

      <div *ngIf="isHistoryOpen" class="history-content-scrollable">
        <ng-container *ngFor="let entry of reversedHistory">
          <div *ngIf="entry.field && (entry.before !== undefined || entry.after !== undefined)" class="history-entry" [hidden]="!entry.before && !entry.after && !entry.changedBy && !entry.timestamp">
            <strong>{{getFieldLabel(entry.field)}}ï¼š</strong>
            <ng-container *ngIf="entry.field === 'assignee'; else normalChange">
              {{historyUserMap.get(entry.before + '') || entry.before}} â†’
              {{historyUserMap.get(entry.after + '') || entry.after}}
            </ng-container>
            <ng-template #normalChange>
              {{entry.before}} â†’ {{entry.after}}
            </ng-template>
            <div class="history-meta" *ngIf="entry.changedBy || entry.timestamp">
              <span *ngIf="entry.changedBy">
                {{historyUserMap.get(entry.changedBy + '') || entry.changedBy}} ãŒ
              </span>
              <span *ngIf="entry.timestamp | safeDate as ts">
                {{ts | date:'yyyy/MM/dd HH:mm'}}ã«æ›´æ–°
              </span>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <div class="form-actions" *ngIf="userRole !== 'viewer'">


      <button mat-stroked-button color="warn" (click)="confirmDeleteDialog()">
        <span class="material-icons">delete</span> å‰Šé™¤
      </button>

      <button mat-stroked-button color="basic" (click)="cancelEdit()">
        <span class="material-icons">undo</span>  æˆ»ã‚‹
      </button>

      <button mat-flat-button color="accent" (click)="openDuplicateDialog()">
        <span class="material-icons">content_copy</span> è¤‡è£½
      </button>

      <button mat-flat-button color="primary" (click)="saveTask()">
        <span class="material-icons">save</span> ä¿å­˜
      </button>
    </div>

  </div>
</div>

<!-- å‰Šé™¤ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div class="custom-dialog-overlay" *ngIf="isConfirmingDelete">
  <div class="custom-dialog">
    <h3 class="dialog-title">ã€Œ{{ task.title }}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
    <p class="dialog-message">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
    <div class="dialog-actions">
      <button class="custom-button cancel-button" (click)="cancelDelete()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="custom-button delete-button" (click)="confirmDelete()">å‰Šé™¤ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- è¤‡è£½ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div class="custom-dialog-overlay" *ngIf="isDuplicatingTask">
  <div class="custom-dialog">
    <h3 class="dialog-title">ã€Œ{{ task.title }}ã€ã®è¤‡è£½</h3>
    <p class="dialog-message">ã‚³ãƒ”ãƒ¼å…ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³</p>
    <select class="dialog-select" [(ngModel)]="selectedCopyTarget">
      <option *ngFor="let section of sections" [value]="section.id">{{ section.title }}</option>
    </select>
    <div class="dialog-actions">
      <button class="custom-button cancel-button" (click)="cancelDuplicate()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="custom-button confirm-button" [disabled]="!selectedCopyTarget" (click)="confirmDuplicate()">è¤‡è£½</button>
    </div>
  </div>
</div>

